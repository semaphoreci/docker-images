version: v1.0
name: First pipeline example
agent:
  machine:
    type: e1-standard-4
    os_image: ubuntu1804
execution_time_limit:
  hours: 10

blocks:
  - name: Build test and push to dockerhub
    task:
      secrets:
        - name: semaphoreci-dockerhub
      prologue:
        commands:
          - echo "${DOCKER_PASSWORD}" | docker login -u "${DOCKER_USERNAME}" --password-stdin
          - curl -L https://goss.rocks/install | sudo sh
          - gem install bundler
          - checkout
          - cache restore gems-$SEMAPHORE_GIT_BRANCH-$(checksum Gemfile.lock),gems-$SEMAPHORE_GIT_BRANCH-,gems-master-
          - bundle install --path vendor/bundle
          - cache store gems-$SEMAPHORE_GIT_BRANCH-$(checksum Gemfile.lock) vendor/bundle
      jobs:
        - name: Build and push ruby
          commands:
            - bundle exec ruby build.rb -d dockerfiles/ruby/latest -r
            - bundle exec ruby build.rb -d dockerfiles/ruby
            - bundle exec ruby build.rb -d dockerfiles/ruby/node -r
            - bundle exec ruby build.rb -d dockerfiles/ruby/browsers
            - bundle exec ruby build.rb -d dockerfiles/ruby/node-browsers
            - artifact push project ruby_new_images || true

        - name: Build and push android
          commands:
            - bundle exec ruby build.rb -d dockerfiles/android -r
            - bundle exec ruby build.rb -d dockerfiles/android/node -r
            - artifact push project android_new_images || true

        - name: Build and push rust
          commands:
            - bundle exec ruby build.rb -d dockerfiles/rust/latest -r
            - bundle exec ruby build.rb -d dockerfiles/rust/node -r
            - bundle exec ruby build.rb -d dockerfiles/rust/browsers
            - bundle exec ruby build.rb -d dockerfiles/rust/node-browsers -r
            - bundle exec ruby build.rb -d dockerfiles/rust
            - artifact push project rust_new_images || true

        - name: Build and push haskell
          commands:
            - bundle exec ruby build.rb -d dockerfiles/haskell/latest -r
            - bundle exec ruby build.rb -d dockerfiles/haskell
            - artifact push project haskell_new_images || true

        - name: Build and push python
          commands:
            - bundle exec ruby build.rb -d dockerfiles/python/latest -r
            - bundle exec ruby build.rb -d dockerfiles/python
            - bundle exec ruby build.rb -d dockerfiles/python/node -r
            - bundle exec ruby build.rb -d dockerfiles/python/browsers -r
            - bundle exec ruby build.rb -d dockerfiles/python/node-browsers -r
            - artifact push project python_new_images || true

        - name: Build and push golang
          commands:
            - bundle exec ruby build.rb -d dockerfiles/golang/latest -r
            - bundle exec ruby build.rb -d dockerfiles/golang/node -r
            - bundle exec ruby build.rb -d dockerfiles/golang/node-browsers -r
            - bundle exec ruby build.rb -d dockerfiles/golang/browsers -r
            - bundle exec ruby build.rb -d dockerfiles/golang
            - artifact push project golang_new_images || true

        - name: Build and push php
          commands:
            - bundle exec ruby build.rb -d dockerfiles/php/latest -r
            - bundle exec ruby build.rb -d dockerfiles/php/browsers -r
            - bundle exec ruby build.rb -d dockerfiles/php
            - bundle exec ruby build.rb -d dockerfiles/php/node -r
            - bundle exec ruby build.rb -d dockerfiles/php/node-browsers -r
            - artifact push project php_new_images || true

        - name: Build and push php with node and browsers
          commands:
            - bundle exec ruby build.rb -d dockerfiles/node/latest -r
            - bundle exec ruby build.rb -d dockerfiles/node/browsers
            - bundle exec ruby build.rb -d dockerfiles/node
            - artifact push project node_new_images || true

        - name: Build and push java/openjdk
          commands:
            - bundle exec ruby build.rb -d dockerfiles/openjdk

        - name: Build and push elixir
          commands:
            - bundle exec ruby build.rb -d dockerfiles/elixir/latest -r
            - bundle exec ruby build.rb -d dockerfiles/elixir/node -r
            - bundle exec ruby build.rb -d dockerfiles/elixir/node-browsers
            - bundle exec ruby build.rb -d dockerfiles/elixir
            - artifact push project elixir_new_images || true

        - name: Build and push clojure
          commands:
            - bundle exec ruby build.rb -d dockerfiles/clojure
            - artifact push project clojure_new_images || true
