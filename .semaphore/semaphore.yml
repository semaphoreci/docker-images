version: v1.0
name: First pipeline example
agent:
  machine:
    type: e1-standard-4
    os_image: ubuntu1804
execution_time_limit:
  hours: 10

blocks:
  - name: Build test and push to dockerhub
    skip:
      when: "branch != 'master'"
    task:
      secrets:
        - name: semaphoreci-dockerhub
      prologue:
        commands:
          - echo "${DOCKER_PASSWORD}" | docker login -u "${DOCKER_USERNAME}" --password-stdin
          - curl -L https://goss.rocks/install | sudo sh
          - gem install bundler
          - checkout
          - cache restore gems-$SEMAPHORE_GIT_BRANCH-$(checksum Gemfile.lock),gems-$SEMAPHORE_GIT_BRANCH-,gems-master-
          - bundle install --path vendor/bundle
          - cache store gems-$SEMAPHORE_GIT_BRANCH-$(checksum Gemfile.lock) vendor/bundle
      jobs:
        - name: Build and push ruby
          commands:
            - bundle exec ruby build.rb -d dockerfiles/ruby/latest -r
            - bundle exec ruby build.rb -d dockerfiles/ruby/browsers -r
            - bundle exec ruby build.rb -d dockerfiles/ruby

        - name: Build and push ruby with node and browsers
          commands:
            - bundle exec ruby build.rb -d dockerfiles/ruby/node -r
            - bundle exec ruby build.rb -d dockerfiles/ruby/node-browsers -r

        - name: Build and push android
          commands:
            - bundle exec ruby build.rb -d dockerfiles/android

        - name: Build and push ubuntu
          commands:
            - bundle exec ruby build.rb -d dockerfiles/ubuntu

        - name: Build and push rust
          commands:
            - bundle exec ruby build.rb -d dockerfiles/rust/latest -r
            - bundle exec ruby build.rb -d dockerfiles/rust/node -r
            - bundle exec ruby build.rb -d dockerfiles/rust/browsers -r
            - bundle exec ruby build.rb -d dockerfiles/rust/node-browsers -r
            - bundle exec ruby build.rb -d dockerfiles/rust

        - name: Build and push haskell
          commands:
            - bundle exec ruby build.rb -d dockerfiles/haskell/latest -r
            - bundle exec ruby build.rb -d dockerfiles/haskell

        - name: Build and push python
          commands:
            - bundle exec ruby build.rb -d dockerfiles/python/latest -r
            - bundle exec ruby build.rb -d dockerfiles/python/browsers -r
            - bundle exec ruby build.rb -d dockerfiles/python

        - name: Build and push python with node and browsers
          commands:
            - bundle exec ruby build.rb -d dockerfiles/python/node -r
            - bundle exec ruby build.rb -d dockerfiles/python/node-browsers -r

        - name: Build and push golang
          commands:
            - bundle exec ruby build.rb -d dockerfiles/golang/latest -r
            - bundle exec ruby build.rb -d dockerfiles/golang/node -r
            - bundle exec ruby build.rb -d dockerfiles/golang/node-browsers -r
            - bundle exec ruby build.rb -d dockerfiles/golang/browsers -r
            - bundle exec ruby build.rb -d dockerfiles/golang

        - name: Build and push php
          commands:
            - bundle exec ruby build.rb -d dockerfiles/php/latest -r
            - bundle exec ruby build.rb -d dockerfiles/php/browsers -r
            - bundle exec ruby build.rb -d dockerfiles/php

        - name: Build and push php with node and browsers
          commands:
            - bundle exec ruby build.rb -d dockerfiles/php/node -r
            - bundle exec ruby build.rb -d dockerfiles/php/node-browsers -r

        - name: Build and push node
          commands:
            - bundle exec ruby build.rb -d dockerfiles/node/latest -r
            - bundle exec ruby build.rb -d dockerfiles/node/browsers -r
            - bundle exec ruby build.rb -d dockerfiles/node

        - name: Build and push java/openjdk
          commands:
            - bundle exec ruby build.rb -d dockerfiles/openjdk

        - name: Build and push elixir
          commands:
            - bundle exec ruby build.rb -d dockerfiles/elixir/latest -r
            - bundle exec ruby build.rb -d dockerfiles/elixir/node -r
            - bundle exec ruby build.rb -d dockerfiles/elixir/node-browsers -r
            - bundle exec ruby build.rb -d dockerfiles/elixir

        - name: Build and push clojure
          commands:
            - bundle exec ruby build.rb -d dockerfiles/clojure

        - name: Build and push alpine
          commands:
            - bundle exec ruby build.rb -d dockerfiles/alpine/latest -r
            - bundle exec ruby build.rb -d dockerfiles/alpine
