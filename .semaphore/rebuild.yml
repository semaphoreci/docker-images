version: v1.0
name: First pipeline example
agent:
  machine:
    type: e1-standard-8
    os_image: ubuntu1804
execution_time_limit:
  hours: 12

blocks:
  - name: Build and push
    task:
      secrets:
        - name: semaphoreci-dockerhub
      prologue:
        commands:
          - echo "${DOCKER_PASSWORD}" | docker login -u "${DOCKER_USERNAME}" --password-stdin
          - curl -L https://goss.rocks/install | sudo sh
          - gem install bundler
          - checkout
          - cache restore gems-$SEMAPHORE_GIT_BRANCH-$(checksum Gemfile.lock),gems-$SEMAPHORE_GIT_BRANCH-,gems-master-
          - bundle install --path vendor/bundle
          - cache store gems-$SEMAPHORE_GIT_BRANCH-$(checksum Gemfile.lock) vendor/bundle
      jobs:
        - name: Build and push ruby
          commands:
            - bundle exec ruby build.rb -d dockerfiles/ruby -r

        - name: Build and push android
          commands:
            - bundle exec ruby build.rb -d dockerfiles/android -r

        - name: Build and push ubuntu
          commands:
            - bundle exec ruby build.rb -d dockerfiles/ubuntu -r

        - name: Build and push rust
          commands:
            - bundle exec ruby build.rb -d dockerfiles/rust -r

        - name: Build and push haskell
          commands:
            - bundle exec ruby build.rb -d dockerfiles/haskell -r

        - name: Build and push python
          commands:
            - bundle exec ruby build.rb -d dockerfiles/python -r

        - name: Build and push golang
          commands:
            - bundle exec ruby build.rb -d dockerfiles/golang -r

        - name: Build and push php
          commands:
            - bundle exec ruby build.rb -d dockerfiles/php -r

        - name: Build and push node
          commands:
            - bundle exec ruby build.rb -d dockerfiles/node -r
