###
### DO NOT MODIFY THIS FILE.  THIS FILE HAS BEEN AUTOGENERATED
###

FROM registry.semaphoreci.com/elixir:1.15.7-otp-24

# Install Java
RUN set -ex && sudo apt-get update && sudo apt-get install -y apt-utils && sudo apt-get dist-upgrade -f -y && sudo apt-get install -y bzip2 libgconf-2-4

RUN if grep -q bookworm /etc/apt/sources.list.d/*; then sudo apt-get install -f -y openjdk-17-jre openjdk-17-jdk; else sudo apt-get install -y -f default-jre default-jdk; fi

# Create Semaphore user
RUN groupadd --gid 8592 semaphore
RUN useradd --uid 8592 --gid semaphore --shell /bin/bash --create-home semaphore
RUN echo 'semaphore ALL=NOPASSWD: ALL' >> /etc/sudoers.d/99-semaphore
RUN echo 'Defaults    env_keep += "DEBIAN_FRONTEND"' >> /etc/sudoers.d/env_keep

# Set User
USER semaphore

# Install firefox
RUN FIREFOX_URL="https://download.mozilla.org/?product=firefox-latest-ssl&os=linux64&lang=en-US" \
    && ACTUAL_URL=$(curl -Ls -o /dev/null -w %{url_effective} $FIREFOX_URL) \
    && curl --silent --show-error --location --fail --retry 3 --output /tmp/firefox.tar.bz2 $ACTUAL_URL \
    && sudo tar -xvjf /tmp/firefox.tar.bz2 -C /opt \
    && sudo ln -s /opt/firefox/firefox /usr/local/bin/firefox \
    && sudo apt-get install -y libgtk3.0-cil-dev libasound2 libasound2 libdbus-glib-1-2 libdbus-1-3 \
    && rm -rf /tmp/firefox.* \
    && firefox --version

# Install Chrome and ChromeDriver
RUN CHROME_VERSION="$(curl https://googlechromelabs.github.io/chrome-for-testing/LATEST_RELEASE_STABLE)" \
    && curl --silent --show-error --location --fail --retry 3 --output /tmp/google-chrome-stable_current_amd64.deb https://dl.google.com/linux/chrome/deb/pool/main/g/google-chrome-stable/google-chrome-stable_${CHROME_VERSION}-1_amd64.deb \
    && curl --silent --show-error --location --fail --retry 3 --output /tmp/chromedriver_linux64.zip "https://edgedl.me.gvt1.com/edgedl/chrome/chrome-for-testing/${CHROME_VERSION}/linux64/chromedriver-linux64.zip" \
    && (sudo dpkg -i /tmp/google-chrome-stable_current_amd64.deb || sudo apt-get -fy install) \
    && rm -rf /tmp/google-chrome-stable_current_amd64.deb \
    && sudo sed -i 's|HERE/chrome"|HERE/chrome" --disable-setuid-sandbox --no-sandbox|g' /opt/google/chrome/google-chrome \
    && google-chrome --version \
    && cd /tmp \
    && unzip chromedriver_linux64.zip \
    && rm -rf chromedriver_linux64.zip \
    && sudo mv chromedriver-linux64/chromedriver /usr/local/bin/chromedriver \
    && sudo chmod +x /usr/local/bin/chromedriver \
    && chromedriver --version

# start xvfb automatically
ENV DISPLAY :99
RUN printf '#!/bin/sh\nXvfb :99 -screen 0 1280x1024x24 &\nexec "$@"\n' > /tmp/entrypoint
RUN chmod +x /tmp/entrypoint
RUN sudo mv /tmp/entrypoint /docker-entrypoint.sh
ENTRYPOINT ["/docker-entrypoint.sh"]
CMD ["/bin/sh"]
